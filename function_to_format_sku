function onFormSubmit(e){
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Respuestas de formulario 1');
  const lastRow = sheet.getLastRow(); // Ajustar el nombre al de la hoja de datos
  const inputCol = 2; // Cambiar este numero si la el campo esta en otra columna (B = 2, C = 3, etc.)
  
  // Obtener encabezados
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  // Verificar si ya existe la columna 'SKU no identificada'
  let invalidCol = headers.indexOf('SKU no identificada') + 1;
  if(invalidCol === 0){
    // No existe, crear al final
    invalidCol = sheet.getLastColumn() + 1;
    sheet.getRange(1, invalidCol).setValue('SKU no identificada');
  }


  let rawInput= sheet.getRange(lastRow, inputCol).getValue();

  
  
  // 1. Verificar si el campo esta vacio
  if (!rawInput || typeof rawInput !== 'string'){
    sheet.getRange(lastRow, inputCol).setComment('⚠️ El campo esta vacio o no contiene texto');
    return;
  }

  // 2. Elimina espacio y saltos de linea
  rawInput = rawInput.replace(/\s+/g, '');

  // 3. Verifica si quedo vacio despues de limpiar
  if (rawInput.length === 0){
    sheet.getRange(lastRow, inputCol).setComment('⚠️ Entrada vacia despues de eliminar espacios.');
    return;
  }

  // 4. Convierte en mayusculas
  rawInput = rawInput.toUpperCase();

  // 5. Divide en bloques de 9 caracteres
  const regex9 = /.{9}/g;
  const allBlocks = rawInput.match(regex9) || [];

  // 6. Validar: 4 letras mayusculas + 5 numeros
  const validPattern = /^[A-Z]{4}[0-9]{5}$/; // Regex correcta

  const validCodes = [];
  const invalidCodes = [];

  // Separa los registros (validos y no validos)
  for (let code of allBlocks){
    if(validPattern.test(code)){
      validCodes.push(code);
    } else {
      invalidCodes.push(code);
    }
  }
  // 7. Si no hay validos, deja nota y termina
  if(validCodes.length === 0){
    sheet.getRange(lastRow, inputCol).setComment('⚠️ No se encontraron codigos validos');
    return;
  }

  // 8. Guarda los validos como lista en la misma celda
  const finalText = validCodes.join('\n');
  sheet.getRange(lastRow, inputCol).setValue(finalText);

  // 9. Si hubo datos invalidos, deja un comentario en la celda
  if(invalidCodes.length > 0) {
    sheet.getRange(lastRow, inputCol).setComment('⚠️ Melis SKU invalidas ignoradas: ' + invalidCodes.join(', '));
  }

  // 10. Guarda los codigos no validos en una nueva columna
  if (invalidCodes.length > 0){
    sheet.getRange(lastRow, invalidCol).setValue(invalidCodes.join('\n'));
  }
}



